# Change and accumulation {#change-accumulation}

Every 10 years, starting in 1790, the US Census Bureau carries out a constitutionally mandated census: a count of the current population. The overall count as a function of year is shown in Figure \@ref(fig:pop-graph). [[Source](https://en.wikipedia.org/wiki/Demographic_history_of_the_United_States)
]



```{r echo=FALSE, message=FALSE, warning=FALSE}
USPop <- readr::read_csv("www/census-totals.csv")
Tmp <- USPop %>% 
  mutate(population=prettyNum(population, big.mark=",")) %>%
  select(-growth_rate)
Table <- if (knitr::is_html_output()) {
  DT::datatable(Tmp) 
} else {
  knitr::kable(Tmp)
}
USPop <- USPop %>% 
  mutate(population = population/1e6)
```

In the 230 years spanned by the census data, the US population has grown 100-fold, from about 4 million in 1790 to about 330,000,000 in 2020.

```{r pop-graph, echo=FALSE, fig.cap="US population since 1790.", fig.margin=TRUE}
popfun <- spliner(population ~ year, data = USPop)
USPop <- USPop %>%
  mutate(yearly_growth_rate = 100*((1+growth_rate/100)^(1/10) - 1))
mod <- lm(population ~ poly(year, 2), data = USPop)
modf <- makeFun(mod)
gf_point(population ~ year, data = USPop) %>%
  gf_line(population ~ year) %>%
  gf_labs(y="Population (millions)") %>%
  gf_lims(x = c(1790, 2100), y=c(0,500))
```




It's always tempting to look for simple patterns in such data. Perhaps the US population has been growing exponentially. A semi-log plot of the same data suggests that the growth is only very roughly exponential. (See Figure \@ref(fig:pop-graph-log).) A truly exponential process would present as a curve with a constant derivative, but the derivative of the function in the graphed is decreasing over the centuries. 


```{r pop-graph-log, echo=FALSE, fig.cap="Population since 1790.", fig.margin=TRUE}
P <- gf_point(population ~ year, data = USPop) %>%
  gf_line(population ~ year) %>%
  gf_labs(y="Population (millions)") %>%
  gf_refine(scale_y_log10())
```

Insofar as the slope over the semi-log graph is informative, it amounts to this quantity:
$$\partial_t \ln(\text{pop}(t)) = \frac{\partial_t\, \text{pop}(t)}{\text{pop}}$$
This is the *per-capita* rate of growth, that is, the rate of change in the population divided by the population. Conventionally, this fraction is presented as a percentage: percentage growth in the population per year, as in Figure \@ref(fig:pop-growth).

```{r pop-growth, echo=FALSE, fig.cap="Annual per capita growth rate of the US population (percent)"}
growth_mod <- lm(yearly_growth_rate ~ year, data = USPop)
growth_fun <- makeFun(growth_mod)
gf_point(yearly_growth_rate ~ year, data = USPop) %>%
  gf_lims(x = c(1790, 2100), y=c(-.5,4)) %>%
  gf_lm() %>%
  gf_labs(y = "Per capita growth rate (% per year)") 
```

The dots in the graph are a direct calculation from the census data.  There's a lot of fluctuation, but an overall trend stands out: the population growth rate has been declining since the mid-to late 1800s. The deviations from the trend are telling and correspond to historical events. There's a relatively low growth rate seen from 1860 to 1870: that's the effect of the US Civil War. The Great depression is seen in the very low growth from 1930 to 1940. Baby Boom: look at the growth from 1950-1960. The bump from 1990 to 2000? Not coincidentally, the 1990 Immigration Act substantially increased the yearly rate of immigration. 

If the trend in the growth rate continues, the US will reach zero net growth about 2070, then continue with negative growth. Of course, negative growth is just decline. A simple prediction from Figure \@ref(fig:pop-growth) is that the argmax of the US population will be around 2070.

How large will the population be when it reaches its maximum? 

In Block 2, we dealt with situations where we know the function $f(t)$ and want to find the rate of change $\partial_t f(t)$. Here, we know the rate of change of the population and we need to figure out the population itself, in other words to figure out from a known $\partial_t f(t)$ what is the (as yet) unknown function $f(t)$.  

The process of figuring out $f(t) \longrightarrow \partial_t f(t)$ is, of course, called ***differentiation***. The opposite process, $\partial_t f(t) \longrightarrow f(t)$ is called ***anti-differentiation***. 


If the trend in the growth rate continues, the US will reach zero net growth about 2070, then continue with negative growth. Of course, negative growth is just decline. A simple prediction from Figure \@ref(fig:pop-growth) is that the argmax of the US population will be around 2070.

How large will the population be when it reaches its maximum? 

In Block 2, we dealt with situations where we know the function $f(t)$ and want to find the rate of change $\partial_t f(t)$. Here, we know the rate of change of the population and we need to figure out the population itself, in other words to figure out from a known $\partial_t f(t)$ what is the (as yet) unknown function $f(t)$.  

The process of figuring out $f(t) \longrightarrow \partial_t f(t)$ is, of course, called ***differentiation***. The opposite process, $\partial_t f(t) \longrightarrow f(t)$ is called ***anti-differentiation***. 

In this block we'll explore the methods for calculating anti-derivatives and some of the settings in which anti-derivative problems arrive. 


::: {.intheworld data-latex=""}
The predictions from the accumulate-population-growth model are shown as a $\color{magenta}{\text{magenta}}$ line in Figure \@ref(fig:pop-prediction-bad).

```{r pop-prediction-bad, echo=FALSE, warning=FALSE, fig.cap="Predicted US population based on the historical linear decline in per-capita growth."}
growth_mod <- lm(yearly_growth_rate ~ year, data = USPop)
growth_fun <- makeFun(growth_mod)
accum <- tibble(year = 2021:2130,
                pop = 331 * cumprod(1 + growth_fun(2021:2130)/100))

gf_point(population ~ year, data = USPop) %>%
  gf_labs(y="Population (millions)") %>%
  gf_lims(x = c(1790, 2130), y=c(0,450)) %>%
  gf_line(pop ~ year, data = accum, color="magenta") %>%
  gf_point(404.4 ~ 2060, color="dodgerblue", size=1)
```

According to the accumulation model, the population peaks in 2075 at 390 million. We'll be back down to the present population level in about 100 years. 

Professional demographers make much more sophisticated models using detailed data from many sources. The demographers at the US Census Bureau predict that the population will reach a maximum of 404 million in 2060, shown by the little blue dot in Figure \@ref(fig:pop-prediction-bad).  That's not too different from what we got by analyzing just the raw census numbers. `r mark(3135)`
:::

## Accumulation

Imagine a simple setting: water flowing out of a tap into a basin or tank. Measurement of the amount of water into the basin will be in a unit of volume, say liters. Measurement of the *flow* $f(t)$ of water from the tap into the tank has different units, say liters per second. If volume $V(t)$ is the volume of water in the tank as a function of time, $f(t)$ at any instant is $f(t) = \partial_t V(t)$. 

Clearly there is a relationship between the two functions $f(t)$ and $V(t)$. With derivatives, we can give a good description of that relationship: $$f(t) = \partial_t V(t)$$ This description will be informative if we have measured the volume of water in the basin as a function of time and want to deduce the rate of flow from the tap. 
Now suppose we have measured $f(t)$ and want to figure out the volume. The volume at any instant is the past flow accumulated to that instant. As a matter of notation, we write this view of the relationship as $$V(t) = \int f(t) dt,$$ which you can read as "volume is the accumulated flow." 

Other examples of accumulation and change:

- velocity is the rate of change of position *with respect to time*. Likewise, position is the accumulation of velocity *over time*.
- force is the rate of energy *with respect to position*. Likewise energy is the accumulation of force *as position changes*. 
- deficit is the rate of change of debt with respect to time. Likewise, debt is the accumulation of deficit over time. 

## Notation for anti-differentiation

For differentiation we are using the notation $\partial_x$ as in $\partial_x f(x - a)$. Remember that the subscript on $\partial$ names the ***with-respect-to input***.  There are three pieces of information this notation:

1. The $\color{magenta}{\partial}$ symbol which identifies the operation as partial ***differentiation***.
2. The name of the with-respect-to input $\partial_{\color{magenta}{x}}$ written as a subscript to $\partial$.
3. The function to be differentiated, $\partial_x \color{magenta}{f(x - a)}$.

For ***anti-differentiation***, our notation must also specify the three pieces of information. It might be tempting to use the same notation as differentiation but replace the $\partial$ symbol with something else, perhaps $\eth$ or $\spadesuit$ or $\forall$, giving us something like $\spadesuit_x f(x-a)$.

Convention has something different in store. The notation for anti-differentiation is $$\large \int f(x-a) dx$$
1. The $\color{magenta}{\int}$ is the marker for anti-differentiation.
2. The name of the with-respect to variable is contained in the "dx" at the end of the notation: $\int f(x-a) d\color{magenta}{x}$
3. The function being anti-differentiated is in the middle $\int \color{magenta}{f(x-a)} dx$.

For those starting out with anti-differentiation, the conventional notation can be confusing, especially the $dx$ part. It's easy confuse $d$ for a constant and $x$ for part of the function being anti-differentiated. 

Think of the $\int$ and the $dx$ as **brackets** around the function. You need both brackets for correct notation, the $\int$ and the $dx$ together telling you what operation to perform. 

Remember that just as $\partial_x f(x-a)$ is a function, so is $\int f(x-a) dx$.

## R/mosaic notation

Recall that the notation for differentiation in R/mosaic is `D(f(x-a) ~ x)`.

This has the same three pieces of information as $\partial_x f(x-a)$

1. `D()` signifies differentiation.
2. `~ x` identifies the with-respect-to variable.
3. `f(x-a) ~ ` is the function on which the operation is to be performed. 

This style of notation extends beautifully to anti-differentiation: `antiD(f(x-a) ~ x)`

Remember that just as `D(f(x-a) ~ x)` creates a new function out of `f(x-a) ~ x`, so does `antiD(f(x-a) ~ x)`.

## Exercises

`r insert_calcZ_exercise("27.02", "bcJnUq", "Exercises/Accum/wolf-beat-book.Rmd")`

`r insert_calcZ_exercise("27.04", "Ya2cVq", "Exercises/Accum/fir-lead-canoe.Rmd")`

`r insert_calcZ_exercise("27.06", "wmyERp", "Exercises/Accum/bee-bid-knife.Rmd")`


`r insert_calcZ_exercise("27.08", "kEAW8g", "Exercises/Accum/dog-have-mattress.Rmd")`


